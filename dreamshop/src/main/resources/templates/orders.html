<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đơn hàng của bạn - Dream Shop</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        
        .order-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }
        
        .order-header {
            border-bottom: 1px solid #eee;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        
        .order-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-shipped {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #74b9ff;
        }
        
        .status-delivered {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #00b894;
        }
        
        .status-cancelled {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #e17055;
        }
        
        .order-item {
            padding: 1rem;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 1rem;
            background: #fafafa;
        }
        
        .product-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .price {
            color: #e91e63;
            font-weight: 600;
        }
        
        .total-price {
            font-size: 1.2em;
            color: #e91e63;
            font-weight: bold;
        }
        
        .empty-orders {
            text-align: center;
            padding: 4rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
        }
        
        .btn-track {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            transition: transform 0.2s;
        }
        
        .btn-track:hover {
            transform: scale(1.05);
            color: white;
        }
        
        .order-timeline {
            position: relative;
            padding-left: 2rem;
        }
        
        .timeline-item {
            position: relative;
            padding-bottom: 1rem;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -2rem;
            top: 0.5rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #28a745;
        }
        
        .timeline-item::after {
            content: '';
            position: absolute;
            left: -1.7rem;
            top: 1.2rem;
            width: 2px;
            height: calc(100% - 0.5rem);
            background-color: #dee2e6;
        }
        
        .timeline-item:last-child::after {
            display: none;
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .order-card {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .product-image {
                width: 60px;
                height: 60px;
            }
            
            .order-timeline {
                padding-left: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-store me-2"></i>Dream Shop
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/shop">Sản phẩm</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/cart">Giỏ hàng</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i> Tài khoản
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="showUserInfo()">Thông tin cá nhân</a></li>
                            <li><a class="dropdown-item" href="/orders">Đơn hàng</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()">Đăng xuất</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Trang chủ</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Đơn hàng</li>
                    </ol>
                </nav>
                <h2 class="mb-0">
                    <i class="fas fa-shopping-bag me-2"></i>Đơn hàng của bạn
                </h2>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Đang tải...</span>
            </div>
            <p class="mt-2">Đang tải đơn hàng...</p>
        </div>

        <!-- Orders Container -->
        <div id="ordersContainer">
            <!-- Orders will be loaded here -->
        </div>

        <!-- Empty Orders -->
        <div id="emptyOrders" class="empty-orders" style="display: none;">
            <i class="fas fa-shopping-bag fa-4x text-muted mb-3"></i>
            <h4>Bạn chưa có đơn hàng nào</h4>
            <p class="text-muted">Hãy thêm một số sản phẩm để tiếp tục mua sắm!</p>
            <a href="/shop" class="btn btn-primary">
                <i class="fas fa-shopping-cart me-2"></i>Bắt đầu mua sắm
            </a>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderDetailModalLabel">Chi tiết đơn hàng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="orderDetailContent">
                    <!-- Order details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;">
        <!-- Alerts will be dynamically added here -->
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let currentUser = null;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadOrders();
        });
        
        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('jwt-token');
            const userId = localStorage.getItem('user-id');
            
            if (!token || !userId) {
                window.location.href = '/login';
                return;
            }
        }
        
        // Load user orders
        async function loadOrders() {
            const token = localStorage.getItem('jwt-token');
            const userId = localStorage.getItem('user-id');
            
            console.log('DEBUG: Loading orders for userId:', userId);
            console.log('DEBUG: Token exists:', !!token);
            
            if (!token || !userId) return;
            
            document.getElementById('loading').style.display = 'block';
            
            try {
                const url = `/api/v1/orders/orderByUserId/${userId}`;
                console.log('DEBUG: Fetching from URL:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('DEBUG: Response status:', response.status);
                console.log('DEBUG: Response ok:', response.ok);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('DEBUG: Orders data:', data);
                    console.log('DEBUG: Data.data exists:', !!data.data);
                    console.log('DEBUG: Data.data type:', typeof data.data);
                    console.log('DEBUG: Data.data length:', data.data ? data.data.length : 'undefined');
                    console.log('DEBUG: Full response structure:', JSON.stringify(data, null, 2));
                    
                    if (data.data && data.data.length > 0) {
                        displayOrders(data.data);
                    } else {
                        console.log('DEBUG: No orders found, showing empty state');
                        showEmptyOrders();
                    }
                } else {
                    const errorData = await response.text();
                    console.error('DEBUG: Failed to load orders:', response.status, errorData);
                    showAlert('Không thể tải đơn hàng: ' + response.status, 'danger');
                    showEmptyOrders();
                }
            } catch (error) {
                console.error('DEBUG: Load orders error:', error);
                showAlert('Không thể tải đơn hàng!', 'danger');
                showEmptyOrders();
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // Display orders
        function displayOrders(orders) {
            console.log('DEBUG: displayOrders called with:', orders);
            console.log('DEBUG: First order structure:', orders[0]);
            console.log('DEBUG: First order items field:', orders[0]?.items);
            console.log('DEBUG: First order orderItems field:', orders[0]?.orderItems);
            
            const container = document.getElementById('ordersContainer');
            document.getElementById('emptyOrders').style.display = 'none';
            
            container.innerHTML = orders.map(order => `
                <div class="order-card">
                    <div class="order-header">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="mb-1">
                                    <i class="fas fa-receipt me-2"></i>Đơn hàng #${order.id}
                                </h5>
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>Ngày đặt: ${formatDate(order.orderDate)}
                                </small>
                            </div>
                            <div class="col-md-6 text-md-end">
                                <span class="order-status ${getStatusClass(order.orderStatus)}">
                                    ${getStatusText(order.orderStatus)}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Order Items -->
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="mb-3">Sản phẩm đã đặt:</h6>
                            ${(order.items || order.orderItems || []).map(item => `
                                <div class="order-item">
                                    <div class="row align-items-center">
                                        <div class="col-2">
                                            <img src="https://via.placeholder.com/80x80?text=Product" 
                                                 alt="${item.productName || 'Product'}" 
                                                 class="product-image"
                                                 onerror="this.src='https://via.placeholder.com/80x80?text=No+Image'">
                                        </div>
                                        <div class="col-6">
                                            <h6 class="mb-1">${item.productName || 'Unknown Product'}</h6>
                                            <small class="text-muted">${item.productBrand || 'Dream Shop'}</small>
                                        </div>
                                        <div class="col-2 text-center">
                                            <span class="fw-bold">x${item.quantity}</span>
                                        </div>
                                        <div class="col-2 text-end">
                                            <span class="price">$${formatPrice(item.price)}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- Order Summary -->
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">Tổng kết đơn hàng</h6>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Tạm tính:</span>
                                        <span>$${formatPrice(order.totalAmount)}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Phí giao hàng:</span>
                                        <span class="text-success">Miễn phí</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <strong>Tổng cộng:</strong>
                                        <strong class="total-price">$${formatPrice(order.totalAmount)}</strong>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <button class="btn btn-track w-100" onclick="viewOrderDetail(${order.id})">
                                            <i class="fas fa-eye me-2"></i>Xem chi tiết
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Show empty orders
        function showEmptyOrders() {
            document.getElementById('ordersContainer').innerHTML = '';
            document.getElementById('emptyOrders').style.display = 'block';
        }
        
        // View order detail
        async function viewOrderDetail(orderId) {
            const token = localStorage.getItem('jwt-token');
            
            try {
                const response = await fetch(`/api/v1/orders/order/${orderId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showOrderDetailModal(data.data);
                } else {
                    showAlert('Không thể tải chi tiết đơn hàng!', 'danger');
                }
            } catch (error) {
                console.error('Error loading order detail:', error);
                showAlert('Có lỗi xảy ra!', 'danger');
            }
        }
        
        // Show order detail modal
        function showOrderDetailModal(order) {
            const modalContent = document.getElementById('orderDetailContent');
            
            modalContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Thông tin đơn hàng</h6>
                        <p><strong>Mã đơn hàng:</strong> #${order.id}</p>
                        <p><strong>Ngày đặt:</strong> ${formatDate(order.orderDate)}</p>
                        <p><strong>Trạng thái:</strong> 
                            <span class="order-status ${getStatusClass(order.orderStatus)}">
                                ${getStatusText(order.orderStatus)}
                            </span>
                        </p>
                        <p><strong>Tổng tiền:</strong> <span class="price">${formatPrice(order.totalAmount)} ₫</span></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Tiến trình đơn hàng</h6>
                        <div class="order-timeline">
                            <div class="timeline-item">
                                <strong>Đơn hàng đã được đặt</strong>
                                <div class="text-muted small">${formatDate(order.orderDate)}</div>
                            </div>
                            ${order.orderStatus !== 'PENDING' ? `
                                <div class="timeline-item">
                                    <strong>Đang xử lý</strong>
                                    <div class="text-muted small">Đơn hàng đang được chuẩn bị</div>
                                </div>
                            ` : ''}
                            ${order.orderStatus === 'SHIPPED' || order.orderStatus === 'DELIVERED' ? `
                                <div class="timeline-item">
                                    <strong>Đã giao cho vận chuyển</strong>
                                    <div class="text-muted small">Đơn hàng đang được vận chuyển</div>
                                </div>
                            ` : ''}
                            ${order.orderStatus === 'DELIVERED' ? `
                                <div class="timeline-item">
                                    <strong>Đã giao hàng thành công</strong>
                                    <div class="text-muted small">Đơn hàng đã được giao đến bạn</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <h6>Chi tiết sản phẩm</h6>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Sản phẩm</th>
                                <th>Đơn giá</th>
                                <th>Số lượng</th>
                                <th>Thành tiền</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.orderItems.map(item => `
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="${getProductImage(item.product)}" 
                                                 alt="${item.product.name}" 
                                                 class="me-2" 
                                                 style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;"
                                                 onerror="this.src='https://via.placeholder.com/40x40?text=No+Image'">
                                            <div>
                                                <div class="fw-bold">${item.product.name}</div>
                                                <small class="text-muted">${item.product.brand || 'Dream Shop'}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>${formatPrice(item.price)} ₫</td>
                                    <td>${item.quantity}</td>
                                    <td class="fw-bold">${formatPrice(item.price * item.quantity)} ₫</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            new bootstrap.Modal(document.getElementById('orderDetailModal')).show();
        }
        
        // Utility functions
        function formatPrice(price) {
            return new Intl.NumberFormat('en-US').format(price);
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function getStatusClass(status) {
            switch(status) {
                case 'PENDING': return 'status-pending';
                case 'SHIPPED': return 'status-shipped';
                case 'DELIVERED': return 'status-delivered';
                case 'CANCELLED': return 'status-cancelled';
                default: return 'status-pending';
            }
        }
        
        function getStatusText(status) {
            switch(status) {
                case 'PENDING': return 'Chờ xử lý';
                case 'SHIPPED': return 'Đang giao hàng';
                case 'DELIVERED': return 'Đã giao hàng';
                case 'CANCELLED': return 'Đã hủy';
                default: return 'Chờ xử lý';
            }
        }
        
        function getProductImage(product) {
            // Since images are JsonIgnored, we'll use a placeholder or default image
            return `https://via.placeholder.com/80x80?text=${encodeURIComponent(product.name.substring(0, 10))}`;
        }
        
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertContainer.innerHTML = alertHtml;
            
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    alertElement.remove();
                }
            }, 5000);
        }
        
        function logout() {
            localStorage.removeItem('jwt-token');
            localStorage.removeItem('user-id');
            window.location.href = '/login';
        }
        
        function showUserInfo() {
            showAlert('Tính năng đang phát triển!', 'info');
        }
    </script>
</body>
</html>
